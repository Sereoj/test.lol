# Версионирование API и структура маршрутов

## Принципы версионирования API

В нашем API применяется версионирование в URL-адресах, что обеспечивает следующие преимущества:

1. **Обратная совместимость**: Клиенты, использующие старую версию API, могут продолжать работать с ней, пока разрабатываются новые версии.
2. **Плавная миграция**: Разработчики клиентов могут постепенно переходить с устаревшей версии API на новую.
3. **Параллельное развитие**: Разные версии API могут разрабатываться одновременно, не влияя друг на друга.
4. **Чистая архитектура**: Код каждой версии API может быть структурирован отдельно, что облегчает его поддержку.

## Текущая структура версионирования

API использует префикс версии в URL-адресах. В настоящее время поддерживается версия `v1`.

### Структура URL с версией

```
https://domain.com/api/v1/{endpoint}
```

### Пример маршрутов с версией

```php
// Версия 1 API (текущая)
Route::prefix('v1')->group(function () {
    // Маршруты версии 1
});
```

## Организация файлов маршрутов

Для обеспечения удобства поддержки и масштабирования маршруты каждой версии API разделены на отдельные файлы в зависимости от требований авторизации:

### Структура директорий

```
routes/
├── api.php                   # Основной файл, объединяющий все версии API
└── api/                      # Директория с файлами маршрутов для разных версий
    └── v1/                   # Маршруты для версии v1
        ├── guest.php         # Маршруты, доступные без авторизации
        ├── auth.php          # Маршруты, требующие авторизации
        └── admin.php         # Маршруты для администраторов
```

### Основной файл маршрутов API

Файл `routes/api.php` служит точкой входа для всех маршрутов API и делегирует запросы в соответствующие файлы в зависимости от версии:

```php
<?php

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;

// Версия 1 API (текущая)
Route::prefix('v1')->group(function () {
    // Маршруты, не требующие авторизации (guest)
    require __DIR__.'/api/v1/guest.php';
    
    // Маршруты, требующие авторизации (auth)
    require __DIR__.'/api/v1/auth.php';
    
    // Маршруты для администраторов
    require __DIR__.'/api/v1/admin.php';
});

// Общий обработчик 404 для неизвестных маршрутов API
Route::fallback(function (Request $request) {
    $method = $request->getMethod();
    $uri = $request->getRequestUri();

    return response()->json([
        'success' => false,
        'error' => 'Route not found or method not supported',
        'supported_methods' => ['GET', 'HEAD', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'],
        'message' => "The request to route {$uri} with method {$method} does not exist.",
    ], 404);
})->name('fallback');
```

## Разделение маршрутов по уровням доступа

Для каждой версии API маршруты разделены на три основные группы:

### 1. Гостевые маршруты (guest.php)

Маршруты, доступные без авторизации:

```php
// Маршруты Socialite и аутентификации
Route::prefix('auth')->middleware('guest')->group(function () {
    // Маршруты аутентификации для неавторизованных пользователей
});

// Публичные маршруты для чтения данных
Route::prefix('posts')->group(function () {
    // Публичные маршруты для чтения данных
});
```

### 2. Маршруты авторизованных пользователей (auth.php)

Маршруты, требующие авторизации:

```php
Route::middleware('auth:api')->group(function () {
    // Маршруты для авторизованных пользователей
});
```

### 3. Административные маршруты (admin.php)

Маршруты, требующие авторизации и роли администратора:

```php
Route::middleware(['auth:api', 'role:admin'])->prefix('admin')->group(function () {
    // Маршруты для администраторов
});
```

## Именование маршрутов

Для обеспечения уникальности имен маршрутов и удобства использования в коде применяется следующая схема именования:

1. **Гостевые маршруты**: `{name}.public`
   Пример: `posts.index.public`

2. **Маршруты авторизованных пользователей**: `{name}`
   Пример: `posts.index`

3. **Административные маршруты**: `admin.{name}`
   Пример: `admin.posts.index`

## Добавление новой версии API

При необходимости создания новой версии API следует:

1. Создать новый каталог `routes/api/v2/` (или следующий номер версии)
2. Создать файлы `guest.php`, `auth.php` и `admin.php` в этом каталоге
3. Добавить новый блок в `routes/api.php`:

```php
// Версия 2 API
Route::prefix('v2')->group(function () {
    require __DIR__.'/api/v2/guest.php';
    require __DIR__.'/api/v2/auth.php';
    require __DIR__.'/api/v2/admin.php';
});
```

## Обработка устаревших версий

При объявлении версии API устаревшей (deprecated) следует:

1. Добавить соответствующие заголовки в ответы API для устаревшей версии
2. Обеспечить минимальный период поддержки (например, 6 месяцев) до полного отключения
3. Предоставить документацию по миграции на новую версию API

Пример добавления заголовка в роутах устаревшей версии:

```php
Route::prefix('v1')->group(function () {
    Route::middleware(function ($request, $next) {
        $response = $next($request);
        $response->header('X-API-Deprecated', 'true');
        $response->header('X-API-Deprecated-Message', 'This API version will be removed on YYYY-MM-DD. Please migrate to v2.');
        return $response;
    })->group(function () {
        require __DIR__.'/api/v1/guest.php';
        require __DIR__.'/api/v1/auth.php';
        require __DIR__.'/api/v1/admin.php';
    });
});
``` 